# Nome del workflow, apparirà nella scheda "Actions" di GitHub
name: "CodeQL Advanced"

# Definisce quando questo workflow deve essere eseguito
on:
  # Esegui quando fai un "push" su QUALSIASI branch
  push:
  # Il filtro 'branches' è stato rimosso per includere tutti i branch

  # Esegui anche sulle "pull request" fatte verso QUALSIFASI branch
  pull_request:
  # Il filtro 'branches' è stato rimosso

  # Esegui anche a un orario fisso (es. ogni Lunedì alle 5:30 UTC)
  schedule:
    - cron: '30 5 * * 1'

# Definisce i "lavori" (jobs) da eseguire
jobs:
  analyze:
    name: Analisi CodeQL
    # Esegui su un server Ubuntu standard di GitHub
    runs-on: ubuntu-latest

    # Permessi necessari al workflow per leggere il codice
    # e scrivere i risultati nella scheda "Security"
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        # Specifichiamo la lingua. Per Android (Java/Kotlin),
        # usiamo 'java-kotlin'.
        language: [ 'java-kotlin' ]

    # Passaggi (steps) che il server eseguirà
    steps:
      # 1. Scarica il tuo codice sul server
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Inizializza lo scanner CodeQL per la lingua scelta
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          # (Opzionale) Decommenta la riga seguente per un'analisi più approfondita
          # query-suite: 'security-extended'


      # --- INIZIO CORREZIONE BUILD ---

      # 3. Imposta l'ambiente Java (JDK 17)
      # Necessario per compilare un progetto Android moderno.
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 4. (Opzionale ma raccomandato) Aggiungi cache per Gradle
      # Questo velocizza molto le build future
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 5. Installa l'SDK Android (specificando le API corrette)
      # Questo è il passaggio mancante. Il server ha bisogno degli strumenti SDK.
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: 34.0.0

      # 6. Accetta le licenze SDK
      # Necessario, altrimenti la build fallisce chiedendo l'accettazione.
      - name: Accept Android SDK licenses
        run: yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses

      # 7. Rendi eseguibile lo script di build Gradle
      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # 8. Compila il progetto (CodeQL osserverà questo processo)
      #    Abbiamo unito 'unset' e 'build' per assicurarci
      #    che la variabile d'ambiente sia disattivata per la build.
      - name: Build with Gradle
        run: |
          unset JAVA_TOOL_OPTIONS
          ./gradlew assembleDebug
      # --- FINE CORREZIONE BUILD ---


      # 9. Esegui l'analisi finale e carica i risultati su GitHub
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{matrix.language}}"

