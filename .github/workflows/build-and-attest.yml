# Nome del workflow, apparir√† nella scheda "Actions" di GitHub
name: "Build and Attest APK"

# Definisce quando questo workflow deve essere eseguito
on:
  # Esegui manually dalla scheda Actions di GitHub
  workflow_dispatch:
    inputs:
      version:
        description: 'Versione dell APK (es. 1.0.0)'
        required: false
        type: string

  # Esegui quando viene creato un tag (es. v1.0.0)
  push:
    tags:
      - 'v*.*.*' # Per esempio: v1.0.0, v1.2.3

# Definisce i "lavori" (jobs) da eseguire
jobs:
  build_and_attest:
    name: Compila e Attesta APK
    runs-on: ubuntu-latest

    # Permessi necessari al workflow per leggere il codice,
    # generare token ID e caricare artefatti
    permissions:
      contents: read
      id-token: write
      attestations: write

    steps:
      # 1. Scarica il tuo codice sul server
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Imposta l'ambiente Java (JDK 17)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Cache per Gradle
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 4. Installa l'SDK Android (API 36)
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 36
          build-tools: 36.0.0

      # 5. Accetta le licenze SDK
      - name: Accept Android SDK licenses
        run: yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses

      # 6. Rendi eseguibile lo script di build Gradle
      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # 7. Compila il progetto
      - name: Build debug APK
        run: |
          unset JAVA_TOOL_OPTIONS
          ./gradlew assembleDebug

      # 8. Genera l'attestazione SLSA per l'APK
      - name: Attest build provenance
        id: attest # Assegna un ID a questo step per referenziarlo
        uses: actions/attest-build-provenance@v1
        with:
          # Percorso al tuo APK compilato
          subject-path: app/build/outputs/apk/debug/app-debug.apk

      # 9. Carica l'APK compilato come artefatto
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: app/build/outputs/apk/debug/app-debug.apk

      # 10. Carica l'attestazione come artefatto
      - name: Upload attestation artifact
        uses: actions/upload-artifact@v4
        with:
          name: attestation-jsonl
          # Usa l'output dello step 'attest' per trovare il file
          path: ${{ steps.attest.outputs.attestation-path }}